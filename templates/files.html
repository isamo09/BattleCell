{% extends "base.html" %}

{% block title %}BattleCell Security - Файлы{% endblock %}

{% block content %}
<div class="files-page">
    {% if not has_master_password %}
    <div class="warning-banner">
        <div class="warning-content">
            <i class="fas fa-exclamation-triangle"></i>
            <div class="warning-text">
                <strong>Мастер-пароль не установлен</strong>
                <p>Для загрузки и скачивания файлов необходимо установить мастер-пароль в настройках аккаунта.</p>
            </div>
            <a href="/settings" class="btn btn-warning">Перейти в настройки</a>
        </div>
    </div>
    {% endif %}
    <div class="page-header">
        <div class="header-content">
            <h1>Файловое хранилище</h1>
            <p>Безопасно храните файлы с полным шифрованием</p>
            <div class="storage-info">
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ storage_info.percentage }}%"></div>
                </div>
                <div class="storage-text">
                    Использовано: {{ storage_info.used_formatted }} из {{ storage_info.max_formatted }} 
                    ({{ storage_info.available_formatted }} свободно)
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showUploadFileModal()" {% if not has_master_password %}disabled{% endif %}>
                <i class="fas fa-upload"></i>
                Загрузить файл
            </button>
            <div class="search-container">
                <input type="text" id="fileSearch" placeholder="Поиск по названию файла... (Ctrl+F)" class="search-input" onkeypress="if(event.key==='Enter') event.preventDefault()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
    </div>
    
    <div class="files-container">
        {% if files %}
        <div class="files-grid">
            {% for file in files %}
            <div class="file-card">
                <div class="file-header">
                    <div class="file-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-info">
                        <h3>{{ file.filename }}</h3>
                        <p class="file-size">{{ (file.size / 1024 / 1024) | round(2) }} MB</p>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn" onclick="downloadFile({{ file.id }})" title="Скачать файл" {% if not has_master_password %}disabled{% endif %}>
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="action-btn" onclick="deleteFile({{ file.id }})" title="Удалить файл">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="file-details">
                    <div class="detail-item">
                        <span class="label">Загружен:</span>
                        <span class="value">{{ file.created_at }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-folder"></i>
            </div>
            <h3>Нет загруженных файлов</h3>
            <p>Загрузите свой первый файл для начала работы</p>
            <button class="btn btn-primary" onclick="showUploadFileModal()" {% if not has_master_password %}disabled{% endif %}>
                <i class="fas fa-upload"></i>
                Загрузить файл
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div id="uploadFileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Загрузить файл</h3>
            <button class="modal-close" onclick="closeModal('uploadFileModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="uploadFileForm" onsubmit="uploadFile(event)">
            <div class="form-group">
                <label for="file">Выберите файл</label>
                <input type="file" id="file" name="file" required>
                <div class="file-info-display" id="fileInfo" style="display: none;">
                    <p>Размер: <span id="fileSize">0</span></p>
                    <p>Тип: <span id="fileType">-</span></p>
                </div>
            </div>
            <div class="form-group">
                <label for="master_password">Мастер-пароль</label>
                <input type="password" id="master_password" name="master_password" required>
            </div>

            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressPercent">0%</span>
                    <span id="progressStatus">Подготовка к загрузке...</span>
                </div>
            </div>

            <div class="modal-actions" id="uploadActions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('uploadFileModal')">Отмена</button>
                <button type="submit" class="btn btn-primary" id="uploadBtn">Загрузить</button>
            </div>
            <div class="modal-actions" id="cancelActions" style="display: none;">
                <button type="button" class="btn btn-danger" onclick="cancelUpload()">Отменить загрузку</button>
            </div>
        </form>
    </div>
</div>



<div id="downloadFileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Введите мастер-пароль</h3>
            <button class="modal-close" onclick="closeModal('downloadFileModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Для скачивания файла необходимо ввести мастер-пароль</p>
            <div class="form-group">
                <label for="downloadMasterPassword">Мастер-пароль</label>
                <input type="password" id="downloadMasterPassword" name="master_password" required>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('downloadFileModal')">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="downloadFileDirect()">Скачать</button>
        </div>
    </div>
</div>

<div id="deleteFileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Удалить файл</h3>
            <button class="modal-close" onclick="closeModal('deleteFileModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы уверены, что хотите удалить этот файл? Это действие нельзя отменить.</p>
            <div class="form-group">
                <label for="deleteFileAccountPassword">Пароль от аккаунта</label>
                <input type="password" id="deleteFileAccountPassword" name="account_password" required>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteFileModal')">Отмена</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteFile()">Удалить</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentFileId = null;
let currentDeleteFileId = null;

function showUploadFileModal() {
    {% if not has_master_password %}
        showNotification('Для загрузки файлов необходимо установить мастер-пароль в настройках', 'error');
        return;
    {% endif %}
    document.getElementById('uploadFileModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function downloadFile(fileId) {
    {% if not has_master_password %}
        showNotification('Для скачивания файлов необходимо установить мастер-пароль в настройках', 'error');
        return;
    {% endif %}
    currentFileId = fileId;
    document.getElementById('downloadFileModal').style.display = 'flex';
}

function deleteFile(fileId) {
    currentDeleteFileId = fileId;
    document.getElementById('deleteFileModal').style.display = 'flex';
}

function confirmDeleteFile() {
    if (!currentDeleteFileId) return;
    
    const accountPassword = document.getElementById('deleteFileAccountPassword').value;
    if (!accountPassword) {
        showNotification('Введите пароль от аккаунта', 'error');
        return;
    }
    
    fetch(`/delete_file/${currentDeleteFileId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `account_password=${encodeURIComponent(accountPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Файл успешно удален!');
            closeModal('deleteFileModal');
            location.reload();
        } else {
            showNotification(data.error || 'Ошибка при удалении файла', 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка при удалении файла', 'error');
    });
}

function downloadFileDirect() {
    if (!currentFileId) return;
    
    const userPassword = document.getElementById('downloadMasterPassword').value;
    if (!userPassword) {
        showNotification('Введите мастер-пароль', 'error');
        return;
    }
    
    fetch(`/download_file/${currentFileId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `master_password=${encodeURIComponent(userPassword)}`
    })
    .then(response => {
        if (response.ok) {
            const contentDisposition = response.headers.get('content-disposition');
            let filename = '';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            return response.blob().then(blob => ({ blob, filename }));
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Ошибка при скачивании файла');
            });
        }
    })
    .then(({ blob, filename }) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'downloaded_file';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        closeModal('downloadFileModal');
        document.getElementById('downloadMasterPassword').value = '';
    })
    .catch(error => {
        showNotification(error.message || 'Ошибка при скачивании файла', 'error');
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        
        fileSize.textContent = formatFileSize(file.size);
        fileType.textContent = file.type || 'Неизвестный тип';
        fileInfo.style.display = 'block';
        
        // Проверяем размер файла
        if (file.size > 500 * 1024 * 1024) {
            showNotification('Файл слишком большой. Максимальный размер: 500MB', 'error');
            e.target.value = '';
            fileInfo.style.display = 'none';
            return;
        }
        
        // Проверяем, что файл не пустой
        if (file.size === 0) {
            showNotification('Файл пустой', 'error');
            e.target.value = '';
            fileInfo.style.display = 'none';
            return;
        }
        
        // Проверяем доступное место (примерная оценка)
        const storageInfo = document.querySelector('.storage-text');
        if (storageInfo) {
            const usedText = storageInfo.textContent;
            const usedMatch = usedText.match(/Использовано: ([\d.]+ [KMGT]B)/);
            if (usedMatch) {
                const usedSize = parseFloat(usedMatch[1]);
                const maxSize = 500; // 500MB
                const fileSizeMB = file.size / (1024 * 1024);
                
                if (usedSize + fileSizeMB > maxSize) {
                    showNotification('Недостаточно места в хранилище', 'error');
                    e.target.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }
            }
        }
    } else {
        document.getElementById('fileInfo').style.display = 'none';
    }
});

function uploadFile(event) {
    event.preventDefault();
    const form = document.getElementById('uploadFileForm');
    const formData = new FormData(form);
    const file = formData.get('file');
    const masterPassword = formData.get('master_password');

    if (!file || !masterPassword) {
        showNotification('Выберите файл и введите мастер-пароль', 'error');
        return;
    }

    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadActions = document.getElementById('uploadActions');
    const cancelActions = document.getElementById('cancelActions');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Загрузка...';
    uploadProgress.style.display = 'block';
    uploadActions.style.display = 'none';
    cancelActions.style.display = 'flex';

    const uploadData = new FormData();
    uploadData.append('file', file);
    uploadData.append('master_password', masterPassword);

    currentUploadXHR = new XMLHttpRequest();

    currentUploadXHR.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percentComplete + '%';
            progressPercent.textContent = percentComplete + '%';
            
            if (percentComplete < 100) {
                progressStatus.textContent = `Загрузка: ${formatFileSize(e.loaded)} из ${formatFileSize(e.total)}`;
            } else {
                progressStatus.textContent = 'Обработка файла...';
            }
        }
    });

    currentUploadXHR.addEventListener('load', function() {
        if (currentUploadXHR.status === 200) {
            try {
                const data = JSON.parse(currentUploadXHR.responseText);
                if (data.success) {
                    progressStatus.textContent = 'Файл успешно загружен!';
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';
                    
                    setTimeout(() => {
                        showNotification('Файл успешно загружен!');
                        closeModal('uploadFileModal');
                        location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Ошибка при загрузке файла');
                }
            } catch (error) {
                progressStatus.textContent = 'Ошибка: ' + error.message;
                setTimeout(() => {
                    resetUploadForm();
                    showNotification(error.message, 'error');
                }, 2000);
            }
        } else {
            try {
                const data = JSON.parse(currentUploadXHR.responseText);
                progressStatus.textContent = 'Ошибка: ' + (data.error || 'Ошибка соединения');
                setTimeout(() => {
                    resetUploadForm();
                    showNotification(data.error || 'Ошибка соединения с сервером', 'error');
                }, 2000);
            } catch (error) {
                progressStatus.textContent = 'Ошибка соединения';
                setTimeout(() => {
                    resetUploadForm();
                    showNotification('Ошибка соединения с сервером', 'error');
                }, 2000);
            }
        }
    });

    currentUploadXHR.addEventListener('error', function() {
        progressStatus.textContent = 'Ошибка сети';
        setTimeout(() => {
            resetUploadForm();
            showNotification('Ошибка сети при загрузке файла', 'error');
        }, 2000);
    });

    currentUploadXHR.addEventListener('abort', function() {
        progressStatus.textContent = 'Загрузка отменена';
        setTimeout(() => {
            resetUploadForm();
        }, 1000);
    });

    currentUploadXHR.open('POST', '/upload_file');
    currentUploadXHR.send(uploadData);
}

function resetUploadForm() {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadActions = document.getElementById('uploadActions');
    const cancelActions = document.getElementById('cancelActions');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');

    uploadBtn.disabled = false;
    uploadBtn.textContent = 'Загрузить';
    uploadProgress.style.display = 'none';
    uploadActions.style.display = 'flex';
    cancelActions.style.display = 'none';
    progressFill.style.width = '0%';
    progressPercent.textContent = '0%';
    progressStatus.textContent = 'Подготовка к загрузке...';
    currentUploadXHR = null;
}

let currentUploadXHR = null;

function cancelUpload() {
    if (currentUploadXHR) {
        currentUploadXHR.abort();
        currentUploadXHR = null;
    }
    resetUploadForm();
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    
    if (modalId === 'uploadFileModal') {
        cancelUpload();
        document.getElementById('uploadFileForm').reset();
        document.getElementById('fileInfo').style.display = 'none';
    }
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icon = type === 'success' ? 'fas fa-check' : 
                 type === 'error' ? 'fas fa-exclamation-triangle' : 
                 type === 'warning' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
    
    notification.innerHTML = `
        <i class="${icon}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// Поиск по файлам
document.getElementById('fileSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const fileCards = document.querySelectorAll('.file-card');
    
    fileCards.forEach(card => {
        const filename = card.querySelector('h3').textContent.toLowerCase();
        
        if (filename.includes(query)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Горячие клавиши для страницы файлов
document.addEventListener('keydown', function(e) {
    // Ctrl+F - Фокус на поиск
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('fileSearch').focus();
    }
    // Ctrl+L или Ctrl+T - Быстрый переход на dashboard
    if (e.ctrlKey && (e.key === 'l' || e.key === 't')) {
        e.preventDefault();
        window.location.href = '/dashboard';
    }
    // Escape - Закрытие модальных окон
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
