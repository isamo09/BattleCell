{% extends "base.html" %}

{% block title %}BattleCell Security - Пароли{% endblock %}

{% block content %}
<div class="passwords-page">
    <div class="page-header">
        <div class="header-content">
            <h1>Хранилище паролей</h1>
            <p>Безопасно управляйте всеми вашими паролями</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showAddPasswordModal()">
                <i class="fas fa-plus"></i>
                Добавить пароль
            </button>
        </div>
    </div>
    
    <div class="passwords-container">
        {% if passwords %}
        <div class="passwords-grid">
            {% for password in passwords %}
            <div class="password-card">
                <div class="password-header">
                    <div class="password-title">
                        <i class="fas fa-key"></i>
                        <h3>{{ password.title }}</h3>
                    </div>
                    <div class="password-actions">
                        <button class="action-btn" onclick="showPassword({{ password.id }})" title="Показать пароль">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" onclick="copyUsername('{{ password.username }}')" title="Копировать имя пользователя">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="action-btn" onclick="editPassword({{ password.id }})" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deletePassword({{ password.id }})" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="password-info">
                    <div class="info-item">
                        <span class="label">Пользователь:</span>
                        <span class="value">{{ password.username }}</span>
                    </div>
                    {% if password.url %}
                    <div class="info-item">
                        <span class="label">URL:</span>
                        <a href="{{ password.url }}" target="_blank" class="value link">{{ password.url }}</a>
                    </div>
                    {% endif %}
                    {% if password.notes %}
                    <div class="info-item">
                        <span class="label">Заметки:</span>
                        <span class="value">{{ password.notes }}</span>
                    </div>
                    {% endif %}
                    <div class="info-item">
                        <span class="label">Добавлен:</span>
                        <span class="value">{{ password.created_at }}</span>
                    </div>
                </div>
                
                <div class="password-password" id="password-{{ password.id }}" style="display: none;">
                    <div class="password-display">
                        <input type="text" id="password-field-{{ password.id }}" readonly>
                        <button class="copy-btn" onclick="copyPassword({{ password.id }})">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-key"></i>
            </div>
            <h3>Нет сохраненных паролей</h3>
            <p>Добавьте свой первый пароль для начала работы</p>
            <button class="btn btn-primary" onclick="showAddPasswordModal()">
                <i class="fas fa-plus"></i>
                Добавить пароль
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div id="addPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Добавить новый пароль</h3>
            <button class="modal-close" onclick="closeModal('addPasswordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addPasswordForm" onsubmit="addPassword(event)">
            <div class="form-group">
                <label for="title">Название</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="username">Имя пользователя</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="url">URL (необязательно)</label>
                <input type="url" id="url" name="url">
            </div>
            <div class="form-group">
                <label for="notes">Заметки (необязательно)</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="master_password">Мастер-пароль</label>
                <input type="password" id="master_password" name="master_password" required>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addPasswordModal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
        </form>
    </div>
</div>

<div id="showPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Введите мастер-пароль</h3>
            <button class="modal-close" onclick="closeModal('showPasswordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Для показа пароля необходимо ввести мастер-пароль</p>
            <div class="form-group">
                <label for="showMasterPassword">Мастер-пароль</label>
                <input type="password" id="showMasterPassword" name="master_password" required>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('showPasswordModal')">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="showPasswordDirect()">Показать пароль</button>
        </div>
    </div>
</div>

<div id="editPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Редактировать пароль</h3>
            <button class="modal-close" onclick="closeModal('editPasswordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Для редактирования пароля необходимо ввести мастер-пароль</p>
            <div class="form-group">
                <label for="editMasterPassword">Мастер-пароль</label>
                <input type="password" id="editMasterPassword" name="master_password" required>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('editPasswordModal')">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="loadPasswordForEdit()">Продолжить</button>
        </div>
    </div>
</div>

<div id="editPasswordFormModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Редактировать пароль</h3>
            <button class="modal-close" onclick="closeModal('editPasswordFormModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editPasswordForm" onsubmit="savePasswordEdit(event)">
            <input type="hidden" id="editPasswordId" name="password_id">
            <div class="form-group">
                <label for="editTitle">Название</label>
                <input type="text" id="editTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="editUsername">Имя пользователя</label>
                <input type="text" id="editUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="editPassword">Пароль</label>
                <input type="password" id="editPassword" name="password" required>
            </div>
            <div class="form-group">
                <label for="editUrl">URL (необязательно)</label>
                <input type="url" id="editUrl" name="url">
            </div>
            <div class="form-group">
                <label for="editNotes">Заметки (необязательно)</label>
                <textarea id="editNotes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="editFormMasterPassword">Мастер-пароль</label>
                <input type="password" id="editFormMasterPassword" name="master_password" required>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editPasswordFormModal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<div id="deletePasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Удалить пароль</h3>
            <button class="modal-close" onclick="closeModal('deletePasswordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы уверены, что хотите удалить этот пароль? Это действие нельзя отменить.</p>
            <div class="form-group">
                <label for="deleteAccountPassword">Пароль от аккаунта</label>
                <input type="password" id="deleteAccountPassword" name="account_password" required>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deletePasswordModal')">Отмена</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeletePassword()">Удалить</button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
let currentPasswordId = null;
let currentDeletePasswordId = null;

function showAddPasswordModal() {
    document.getElementById('addPasswordModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showPassword(passwordId) {
    currentPasswordId = passwordId;
    document.getElementById('showPasswordModal').style.display = 'flex';
}

function showPasswordDirect() {
    if (!currentPasswordId) return;
    
    const userPassword = document.getElementById('showMasterPassword').value;
    if (!userPassword) {
        alert('Введите мастер-пароль');
        return;
    }
    
    fetch(`/get_password/${currentPasswordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `master_password=${encodeURIComponent(userPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.password) {
            const passwordField = document.getElementById(`password-field-${currentPasswordId}`);
            passwordField.value = data.password;
            document.getElementById(`password-${currentPasswordId}`).style.display = 'block';
            closeModal('showPasswordModal');
            document.getElementById('showMasterPassword').value = '';
        } else {
            alert(data.error || 'Ошибка при получении пароля');
        }
    })
    .catch(error => {
        alert('Ошибка при получении пароля');
    });
}

function editPassword(passwordId) {
    currentPasswordId = passwordId;
    document.getElementById('editPasswordModal').style.display = 'flex';
}

function loadPasswordForEdit() {
    if (!currentPasswordId) return;

    const masterPassword = document.getElementById('editMasterPassword').value;
    if (!masterPassword) {
        alert('Введите мастер-пароль для продолжения редактирования');
        return;
    }

    fetch(`/get_password/${currentPasswordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `master_password=${encodeURIComponent(masterPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.password) {
            document.getElementById('editPasswordId').value = currentPasswordId;
            document.getElementById('editTitle').value = data.title;
            document.getElementById('editUsername').value = data.username;
            document.getElementById('editPassword').value = data.password;
            document.getElementById('editUrl').value = data.url || '';
            document.getElementById('editNotes').value = data.notes || '';
            document.getElementById('editFormMasterPassword').value = masterPassword;
            document.getElementById('editPasswordFormModal').style.display = 'flex';
            closeModal('editPasswordModal');
        } else {
            alert(data.error || 'Ошибка при загрузке пароля для редактирования');
        }
    })
    .catch(error => {
        alert('Ошибка при загрузке пароля для редактирования');
    });
}

function savePasswordEdit(event) {
    event.preventDefault();
    const form = document.getElementById('editPasswordForm');
    const formData = new FormData(form);
    const masterPassword = formData.get('master_password');

    fetch(`/edit_password/${currentPasswordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `title=${encodeURIComponent(formData.get('title'))}&username=${encodeURIComponent(formData.get('username'))}&password=${encodeURIComponent(formData.get('password'))}&url=${encodeURIComponent(formData.get('url'))}&notes=${encodeURIComponent(formData.get('notes'))}&master_password=${encodeURIComponent(masterPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Пароль успешно обновлен!');
            closeModal('editPasswordFormModal');
            location.reload();
        } else {
            alert(data.error || 'Ошибка при обновлении пароля');
        }
    })
    .catch(error => {
        alert('Ошибка при обновлении пароля');
    });
}

function deletePassword(passwordId) {
    currentDeletePasswordId = passwordId;
    document.getElementById('deletePasswordModal').style.display = 'flex';
}

function confirmDeletePassword() {
    if (!currentDeletePasswordId) return;
    
    const accountPassword = document.getElementById('deleteAccountPassword').value;
    if (!accountPassword) {
        alert('Введите пароль от аккаунта');
        return;
    }
    
    fetch(`/delete_password/${currentDeletePasswordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `account_password=${encodeURIComponent(accountPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Пароль успешно удален!');
            closeModal('deletePasswordModal');
            location.reload();
        } else {
            alert(data.error || 'Ошибка при удалении пароля');
        }
    })
    .catch(error => {
        alert('Ошибка при удалении пароля');
    });
}

function copyUsername(username) {
    navigator.clipboard.writeText(username).then(() => {
        showNotification('Имя пользователя скопировано');
    });
}

function copyPassword(passwordId) {
    const passwordField = document.getElementById(`password-field-${passwordId}`);
    navigator.clipboard.writeText(passwordField.value).then(() => {
        showNotification('Пароль скопирован');
    });
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <i class="fas fa-check"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function addPassword(event) {
    event.preventDefault();
    const form = document.getElementById('addPasswordForm');
    const formData = new FormData(form);
    const masterPassword = formData.get('master_password');

    fetch('/add_password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `title=${encodeURIComponent(formData.get('title'))}&username=${encodeURIComponent(formData.get('username'))}&password=${encodeURIComponent(formData.get('password'))}&url=${encodeURIComponent(formData.get('url'))}&notes=${encodeURIComponent(formData.get('notes'))}&master_password=${encodeURIComponent(masterPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Пароль успешно добавлен!');
            closeModal('addPasswordModal');
            location.reload();
        } else {
            alert(data.error || 'Ошибка при добавлении пароля');
        }
    })
    .catch(error => {
        alert('Ошибка при добавлении пароля');
    });
}


window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}

